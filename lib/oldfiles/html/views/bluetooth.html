<style>
    .modal-dialog-center {
        margin-top: 30%;
    }
</style>

<script src="/static/js/vendor/require.js"></script>

<script>
    require(['vendor/jquery', 'vendor/moment', 'vendor/jquery.jeditable'], function($, moment) {
        /**
         * BluetoothHost is the Android provided (via the App) global variable that we
         * can use to call the Android Java functions.
         *
         */

//---------------------------

        var bluetoothDeviceTemplate = '<button class="list-group-item btn btn-default btn-lg btn-block" id="%id">'
                + '<h3>%device</h3>'
                + '<p>%address</p>'
                + '</button>';

        var scadPropertiesTemplate = '<tr>'
                + '<td><b>%key</b></td>'
                + '<td class="editable scad_properties_cell">%value</td>'
                + '</tr>';

        var scadRecordingTemplate = '<tr>'
                + '<td><b>%name</b><br />%filesize, created at %creationdate</td>'
                + '<td><button class="btn btn-default btn-sm" onclick="TransferFile(\'%name\', \'%filesize\', %filesizeInBytes);">Transfer</button></td>'
                + '<td><button class="btn btn-default btn-sm btn-danger" onclick="DeleteFile(\'%name\');">Delete</button></td>'
                + '</tr>';

        /**
         * 
         * @param {type} filename
         * @param {type} filesize A string with the size and units of the file being transfered
         * @returns {undefined}
         */
        var ShowModal = function(filename, filesize, filesizeInBytes) {
            $("#modalTransferHeaderStatus").text('In Progress');

            $('#modalTransferFile').modal('show');
            $("#modalTransferFileCloseButton").hide();
            $("#modalTransferFileCancelButton").show();

            $('#modalTransferFilename').text(filename);
            $('#modalTransferTotal').text(filesize);

            var startTime = moment();

            var modalTransferTotalDownloaded = $('#modalTransferTotalDownloaded');
            var modalTransferSpeed = $('#modalTransferSpeed');
            var modalTransferElapsedTime = $('#modalTransferElapsedTime');
            var modalTransferRemainingTime = $('#modalTransferRemainingTime');

            var interval = setInterval(function() {

                var elapsedMs = moment().diff(startTime);
                var bytesTransfered = BluetoothHost.GetRecordingBytesTransfered();
                var transferSpeed = bytesTransfered / (elapsedMs / 1000.0);
                var bytesRemaining = filesizeInBytes - bytesTransfered;
                var remainingMs = bytesRemaining / (bytesTransfered / elapsedMs);


                modalTransferTotalDownloaded.text((bytesTransfered / 1024).toFixed(2) + " KB");
                modalTransferSpeed.text((transferSpeed / 1024).toFixed(2) + ' KB/s');
                modalTransferElapsedTime.text(moment.utc(elapsedMs).format('mm:ss'));
                modalTransferRemainingTime.text(moment.utc(remainingMs).format('mm:ss'));



                var doneBytes = BluetoothHost.GetRecordingDone();
                if (doneBytes !== -1) {
                    clearInterval(interval);
                    $("#modalTransferFileCloseButton").show();
                    $("#modalTransferFileCancelButton").hide();
                    if (doneBytes === filesizeInBytes) {
                        $("#modalTransferHeaderStatus").text('Done');
                    } else {
                        $("#modalTransferHeaderStatus").text('Erorr');
                        CheckConnection(function() {
                            alert('Unknown error occured during transfer: could not transfer all bytes.'
                                    + 'Transfered ' + doneBytes + ' bytes out of ' + filesizeInBytes);
                        });

                    }
                }
            }, 500);

            $('#modalTransferFileCancelButton').on('click', function() {
                clearInterval(interval);
                BluetoothHost.GetRecordingCancel();
                $("#modalTransferHeaderStatus").text('Cancelled');
                $("#modalTransferFileCloseButton").show();
                $("#modalTransferFileCancelButton").hide();
            });
        };

        var TransferFile = function(filename, filesize, filesizeInBytes) {
            console.log("JS: Transfering file " + filename);
            CheckConnection(function() {
                var result = BluetoothHost.GetRecording(filename, filename);
                if (result === true) {
                    ShowModal(filename, filesize, filesizeInBytes);
                } else {
                    alert("Could not start file transfer.");
                }
            });

        };

        var DeleteFile = function(filename) {
            alert("Sorry, deleting is not supported right now.");
        };

        var AddPropertyToTable = function(name, value) {
            $("#scadpropertytable").append(
                    scadPropertiesTemplate
                    .replace("%key", name)
                    .replace("%value", value)
                    );
            $('.editable').editable(function(editedValue, settings) {
                console.log(this);
                console.log(editedValue);
                console.log(settings);

                CheckConnection(function() {
                    BluetoothHost.SetParameter(name, editedValue);
                });

                return(editedValue);
            }, {
                type: 'text',
                width: ($('.scad_properties_cell').width() - 10) + "px",
                height: ($('.scad_properties_cell').height() + 8) + "px"
            });
        };

        var AddLineToRecordingTable = function(filename, filesize, creationdate, filesizeInBytes) {
            console.log('filesizeInBytes: ' + filesizeInBytes);

            var row = scadRecordingTemplate
                    .replace("%name", filename) // Three times to replace all 3 of the recordings.
                    .replace("%name", filename)
                    .replace("%name", filename)
                    .replace("%filesizeInBytes", filesizeInBytes)
                    .replace("%filesize", filesize) // and twice for the two filesizes
                    .replace("%filesize", filesize)
                    .replace("%creationdate", creationdate);

            console.log('Row: ' + row);


            $("#scadavailablerecordingstable").append(
                    row
                    );
        };

        var GetConnectionInformation = function() {
            var result = $.parseJSON(BluetoothHost.GetParameters());
            if (typeof result.error === "undefined") {
                $("#scadpropertytable").empty();
                for (var key in result) {
                    AddPropertyToTable(result[key].prettyName, result[key].value);
                }

            } else {
                alert("Could not get properties.");
            }
        };


        var CheckConnection = function(connectionAvailableCallback) {
            if (typeof BluetoothHost !== 'undefined') {
                if (BluetoothHost.IsConnected()) {
                    connectionAvailableCallback();
                } else {
                    alert('Bluetooth not connected.');
                    $('#bluetoothDisconnectedDiv').show().siblings('div').hide();
                }

            } else {
                alert('BluetoothHost is undefined! You must be running an Android device to use Bluetooth.');
            }
        };

        var updateSCADClock = function() {
            if (typeof BluetoothHost !== "undefined") {
                CheckConnection(function() {
                    var now = new Date();
                    console.log("Before setting time");
                    if (BluetoothHost.SetDateTime(
                            now.getUTCFullYear(),
                            now.getUTCMonth() + 1, // UTC months start at 0.
                            now.getUTCDate(), // Get the day of month
                            now.getUTCHours(),
                            now.getUTCMinutes(),
                            now.getUTCSeconds()
                            )) {
                        alert("Successfully set SCAD clock.");
                    } else {
                        alert('Failed to set SCAD clock');
                    }
                });
            }
        };



        var GetAvailableRecordings = function() {
            var result = $.parseJSON(BluetoothHost.GetAvailableRecordings());
            if (typeof result.recordings !== "undefined") {
                $("#scadavailablerecordingstable").empty();
                for (var index = 0; index < result.recordings.length; index++) {

                    var createdate = moment(result.recordings[index].creationdate).format("YYYY-MM-DD  hh:mm:ss a");
                    var filesize = (result.recordings[index].filesize / 1024).toFixed(2) + " KB";

                    AddLineToRecordingTable(result.recordings[index].filename,
                            filesize,
                            createdate,
                            result.recordings[index].filesize
                            );
                }
            } else {
                alert("No recordings! This is likely a problem with the App. Please report.");
            }
        };

        var AddBluetoothDevice = function(name, address) {
            var id = "id-" + address.replace(/:/g, "d");

            $("#bluetoothDeviceList").append(
                    bluetoothDeviceTemplate
                    .replace("%device", name)
                    .replace("%address", address)
                    .replace("%id", id)
                    );
            $("#" + id).on('click', function() {

                if (typeof BluetoothHost !== "undefined") {

                    $('#bluetoothConnectingDiv').show().siblings('div').hide();

                    // Need to add timeout. Otherwise, the blocking below prevents
                    // the screen from being updated. So the timeout frees up some
                    // processor cycles to take care of that.
                    setTimeout(function() {
                        BluetoothHost.ConnectTo(address); // Blocking
                        if (BluetoothHost.IsConnected()) {
                            $('#bluetoothConnectedDiv').show().siblings('div').hide();
                            GetConnectionInformation();
                            GetAvailableRecordings();

                        } else {
                            $('#bluetoothDisconnectedDiv').show().siblings('div').hide();
                            alert("Could not connect to device selected.");
                        }
                    }, 50);

                }

            });
        };


        $(document).ready(function() {
            if (typeof BluetoothHost !== "undefined") {

                console.log('Setting info: {{user.id}} {{user.displayName}} {{user.email}}');
                BluetoothHost.SetUserInfo('{{user.id}}', '{{user.displayName}}', '{{user.email}}');

                $("#BluetoothAvailableDiv").show().siblings('div').hide();

                if (BluetoothHost.IsConnected()) {
                    console.log('page refreshed, so get SCAD info');
                    $('#bluetoothConnectedDiv').show().siblings('div').hide();
                    GetConnectionInformation();
                    GetAvailableRecordings();
                } else {
                    $('#bluetoothDisconnectedDiv').show().siblings('div').hide();
                }

                $("#bluetoothDeviceList").empty();
                var devices = $.parseJSON(BluetoothHost.GetBluetoothDevices());

                if (typeof devices === "undefined") {
                    //TODO(SRLM): Do something
                }

                for (var i = 0; i < devices.devices.length; i++) {
                    AddBluetoothDevice(devices.devices[i].name, devices.devices[i].address);
                }


                $("#bluetoothDisconnectButton").on('click', function() {
                    BluetoothHost.Disconnect();
                    $('#bluetoothDisconnectedDiv').show().siblings('div').hide()
                });

            } else {
                $("#NoBluetoothAvailableDiv").show().siblings('div').hide();
            }

            $('#forceAppCrashButton').on('click', function() {
                BluetoothHost.ForceCrash();
            });
        });

    });

</script>

<div class="modal" id="modalTransferFile">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header h3">
                Recording Transfer ( <span id="modalTransferHeaderStatus"></span> )
            </div>
            <div class="modal-body">
                <p class='h4'><span id="modalTransferTotalDownloaded">0</span> /<span id="modalTransferTotal">0</span> (<span id="modalTransferSpeed">0</span>)</p>
                <p><span id="modalTransferElapsedTime">00:00</span> elapsed, <span id="modalTransferRemainingTime">00:00</span> remaining</p>

                <p>File saved to your Download folder under "<span id="modalTransferFilename"></span>" (try using ES File explorer to find it)</p>
            </div>
            <div class="modal-footer">
                <button id="modalTransferFileCancelButton" type="button" class="btn btn-danger">Cancel Transfer</button>
                <button id="modalTransferFileCloseButton" type="button" data-dismiss="modal" class="btn">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div>
    <div id="NoBluetoothAvailableDiv">
        <h2>Bluetooth is available with our Android App:</h2>
        <a href="https://play.google.com/store/apps/details?id=com.redninesensor.android"><img src="images/androidappstore.jpg"/></a>
    </div>

    <div id="BluetoothAvailableDiv">
        <div>
            <div id ="bluetoothDisconnectedDiv">
                <h3>Connect to a device:</h3>

                <ul class="list-group" id="bluetoothDeviceList">
                    <li class="list-group-item">(No devices available)</li>
                </ul>

                <h4>Don't see you device listed? Try scanning and pairing from the System Bluetooth Panel first, then restart the App.</h4>
            </div>

            <div id="bluetoothConnectingDiv">
                <h4>Connecting to selected device...</h4>
            </div>


            <div id="bluetoothConnectedDiv">
                <a class="btn btn-default btn-lg btn-block" id="bluetoothDisconnectButton">Disconnect from SCAD</a>

                <h3>Properties</h3>
                <table cellpadding="3" cellspacing="3" class="table table-striped" id="scadpropertytable">
                </table>

                <button onclick="updateSCADClock()" type="button" class="btn btn-default">Sync SCAD Clock to Phone</button>

                <h3>Available Recordings</h3>
                <table cellpadding="3" cellspacing="3" class="table table-striped" id="scadavailablerecordingstable">
                </table>



                <!--        <h3>Controls</h3>
                        <a class="btn btn-success btn-lg btn-block" id="startRecordingButton">Begin Recording</a>
                        <a class="btn btn-danger btn-lg btn-block" id="endRecordingButton">Stop Recording</a>
                        <br />
                        <a class="btn btn-warning btn-lg btn-block" id="startRecordingButton">Turn Off</a>-->
            </div>
        </div>

        <div>
            <br/><br/><br/><br/><br/><br/>
            <button id="forceAppCrashButton" class="btn btn-sm btn-danger">Force App Crash</button>
        </div>

    </div>
</div>

