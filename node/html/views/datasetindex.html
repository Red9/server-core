<div class="alert alert-warning">Some features are still a work in progress, so if you try using a filter and don't get a result don't be surprised.</div>

<h1>Explore</h1>
<form id="filter-form" class="filters clearfix">
    <div class="panel panel-default">
        <div class="row">
            <div class="col-lg-6 filter-item ignore">
                <div class="row">
                    <div class="col-sm-3"><h3>Type</h3></div>
                    <div class="col-sm-9">
                        <ul class="nav nav-pills simple">
                            <li class="active"><a href="#">Dataset<input type="radio" name="type" id="type-dataset" checked></a></li>
                            <li><a href="#">Event<input type="radio" name="type" id="type-event"></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 filter-item">
                <div class="row">
                    <div class="col-sm-3"><h3>User</h3></div>
                    <div class="col-sm-5">
                        <select id="user-list" name="owner" class="form-control" multiple></select>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 filter-item inactive" id="event-type-filter">
                <div class="row">
                    <div class="col-sm-3"><h3>Event type</h3></div>
                    <div class="col-sm-5">
                        <select name="type" id="event-type" class="form-control" multiple></select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 filter-item">
                <div class="row">
                    <div class="col-sm-3"><h3>Date</h3></div>
                    <div class="col-sm-2"><label for="timespan">Within</label></div>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input type="number" id="timespan" class="form-control ignore" />
                            <span class="input-group-addon">day(s)</span>
                        </div>
                    </div>
                    <div class="col-sm-1"><label for="datetime">Of</label></div>
                    <div class="col-sm-3">
                        <input type="text" id="datetime" class="form-control ignore">
                    </div>
                </div>
                <input type="hidden" id="endTime-more" name="endTime.more">
                <input type="hidden" id="startTime-less" name="startTime.less">
            </div>
            <div class="col-lg-6 filter-item" id="duration-filter">
                <div class="row">
                    <div class="col-sm-3"><h3>Duration</h3></div>
                    <div class="col-sm-9">
                        <div class="slider"
                             id="duration"
                             data-name="summaryStatistics.static.time.duration.value"
                             data-max="180"
                             data-tovalue="minToMs"
                             data-units="min"></div>
                        <div class="slider-label"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 filter-item" id="location-filter">
                <div class="row">
                    <div class="col-sm-3"><h3>Location</h3></div>
                    <div class="col-sm-2"><label for="distance">Within</label></div>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input type="number" id="distance" class="form-control ignore" />
                            <span class="input-group-addon">mi</span>
                        </div>
                    </div>
                    <div class="col-sm-1"><label>Of</label></div>
                    <div class="col-sm-3">
                        <span id="location-remove" class="glyphicon glyphicon-remove"></span>
                        <a href="#">
                            <span class="glyphicon glyphicon-map-marker"></span>
                            <span id="location-label">Select</span>
                        </a>
                        <input type="hidden" id="intersects" value="">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="map">
                <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzYsEDTVazN_ic9SsHVvhcSCLwlLEHd7Q&sensor=true"></script>
                <div id="map-canvas"></div>
            </div>
        </div>
        <div id="additional-filters-container"></div>
        <div class="row">
            <div class="col-lg-12 buttons">
                <button class="btn btn-success">Search</button>
                <button class="btn btn-default btn-clear">Clear</button>
                <div class="btn-group" id="additional-filters-button">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        More filters <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu pull-right" role="menu">
                        <li><a href="#" data-name="static.route.path.distance.value" data-template="slider" data-title="Distance" data-units="mi" data-tovalue="mileToMeter">Path distance</a></li>
                        <li class="divider"></li>
                        <li><a href="#" data-name="instantaneous.acceleration.magnitude.average" data-template="slider" data-title="Instantaneous acceleration" data-max="150" data-units="m<sub>/s<sup>2</sup></sub>">Instantaneous acceleration</a></li>
                        <li><a href="#" data-name="instantaneous.rotationrate.magnitude.average" data-template="range-input" data-title="Instantaneous rotation" data-units="<sup>rad</sup><sub>/s</sub>">Instantaneous average rotation rate</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="text/x-handlebars-template" id="tmpl-filter-range-input">
        <div class="row" id="filter-\{{id}}">
        <div class="col-lg-6 filter-item">
        <div class="row">
        <div class="col-sm-3"><h3>\{{title}}</h3></div>
        <div class="col-sm-2"><label>More than</label></div>
        <div class="col-sm-2">
        <div class="input-group">
        <input type="number" name="\{{name}}.more" class="form-control" />
        <span class="input-group-addon">\{{{units}}}</span>
        </div>
        </div>
        <div class="col-sm-2"><label>Less than</label></div>
        <div class="col-sm-2">
        <div class="input-group">
        <input type="number" name="\{{name}}.less" class="form-control" />
        <span class="input-group-addon">\{{{units}}}</span>
        </div>
        </div>
        </div>
        </div>
        </div>
    </script>
    <script type="text/x-handlebars-template" id="tmpl-filter-slider">
        <div class="row" id="filter-\{{id}}">
        <div class="col-lg-6 filter-item">
        <div class="row">
        <div class="col-sm-3"><h3>\{{title}}</h3></div>
        <div class="col-sm-9">
        <div class="slider" data-name="\{{name}}" data-tovalue="\{{tovalue}}"></div>
        <div class="slider-label"></div>
        </div>
        </div>
        </div>
        </div>
    </script>
</form>
<script>
site.urls.apiPath = '{{apiUrl}}'; // Global variable accessible to all handlebars rendered pages.

$('#filter-form').submit(function(e) {
    e.preventDefault();
    site.search();
});
$('.filters .nav.simple a').click(function() {
    $(this).closest('.nav').children('li').removeClass('active');
    $(this).closest('li').addClass('active');
    $('input', this).prop('checked', true);
    return false;
});
$('.filters .nav.multiple a').click(function() {
    $(this).closest('li').toggleClass('active');
    $('input', this).prop('checked', !$('input', this).prop('checked'));
});
$('#type-event').closest('.nav').find('a').click(function() {
    var isDataset = !$('#type-event').prop('checked');
    $('#event-type-filter').toggleClass('inactive', isDataset);
    var sliderElement = $("#duration-filter .slider");
    var maxDuration = 15;
    if (isDataset) {
        maxDuration = 180;
    }
    sliderElement.slider('option', 'max', maxDuration);
    sliderElement.slider('values', [0, 0]);
});
$('#location-label').closest('a').click(function() {
    var mapContainer = $('.filters .map');
    if (mapContainer.is(':visible')) {
        mapContainer.hide();
        return false;
    }
    mapContainer.show();
    if (!mapContainer.data('mapLoaded')) {
        mapContainer.data('mapLoaded', true);
        site.setMap(39.4114, -96.90834, 4, function(lat, lng, name) {
            if (!$('#distance').val()) {
                $('#distance').val(10);
            }
            $('#intersects').val('circle(' + lat + ',' + lng + ',' + site.mileToMeter($('#distance').val()) + ')');
            $('#location-remove').show();
            if (name) {
                if (!$('#location-label').data('default-text')) {
                    $('#location-label').data('default-text', $('#location-label').text());
                }
                $('#location-label').val(name).text(name);
            }
        });
    }
    return false;
});
$('#distance').change(function () {
    var targetElement = $('#intersects');
    var values = $('#intersects').val().split(',');
    if (values.length === 3) {
        targetElement.val('circle(' + values[0] + ',' + values[1] + ',' + site.mileToMeter($(this).val()) + ')');
    }
});
$('#datetime, #timespan').change(function() {
    var date = $('#datetime').val();
    var span = $('#timespan').val();
    if (!date || !span || span === '0' || isNaN(Date.parse(date)) || isNaN(parseInt(span, 10))) {
        $('#endTime-more').val('');
        $('#startTime-less').val('');
        return;
    }
    var baseDate = Date.parse(date);
    var days = parseInt(span, 10);
    $('#endTime-more').val(baseDate - days * 24 * 60 * 60 * 1000);
    $('#startTime-less').val(baseDate + (days + 1) * 24 * 60 * 60 * 1000);
});
$('#location-remove').click(function() {
    $('#intersects').val(null).text(null);
    $('#location-label').text($('#location-label').data('default-text'));
    $('.filters .map, #location-remove').hide();
    site.clearMap();
    $('#distance').val(null);
});
$('#additional-filters-button li a').click(function() {
    var state = $(this).data();
    if (!state.name)
        return true;
    state.id = state.name.replace(/\./g, "-");
    if (!$('#filter-' + state.id).length) {
        var templateId = 'tmpl-filter-' + state.template;
        if (!site.templates[templateId]) {
            site.templates[templateId] = Handlebars.compile($('#' + templateId).html());
        }
        var filter = $(site.templates[templateId](state));
        filter.addClass('additional-filter');
        $('#additional-filters-container').append(filter);
        if ($(".slider", filter).length) {
            site.setSlider(filter, state);
        }
    }
    //now its added to the dom
    $('#filter-' + state.id).show().css({backgroundColor: '#BCE8F1'}).animate({backgroundColor: 'transparent'}, 1000);
    return true;
});
$('.filters .btn-clear').click(function() {
    site.clearSearchFilter();
    return false;
});
$(function() {
    site.setSlider($("#duration-filter"), $('.slider', $("#duration-filter")).data());
    $('#datetime').datepicker();
    $('#filter-form').submit();
    $.getJSON(site.urls.eventTypes, function (list) {
        $.each(list, function () {
            $('#event-type').append('<option>' + this.name + '</option>');
        });
    });
    $.getJSON(site.urls.apiPath + site.urls.userList, function (list) {
        $.each(list.sort(site.sortBy('displayName')), function () {
            $('#user-list').append('<option id="' + this.id + '">' + this.displayName + '</option>');
        });
    });
});

var usrModalInstance;
var GetUSROperands = function() {
    
    var checked = site.getChecked();
    console.log('Result type: ' + $('#resultType').attr('value'));
    
    var result = {
        datasets: checked
    };
    return result;
};

</script>
<div id="usr_modal_div"></div>

<div id="container-results"></div>
<script type="text/x-handlebars-template" id="tmpl-results">
    \{{#if items.length }}
        <p class="text-right text-muted">\{{paging.totalResults}} results found</p>
        <div id="resultType" value="\{{type.string}}"></div>
        <div class="panel panel-default results">
            \{{#if type.dataset }}
            <div class="table-responsive">
                <table class="table table-hover table-condensed">
                    <thead>
                        <th>
                            <div class="btn-toolbar" role="toolbar"><div class="btn-group">
                            <button class="btn btn-md btn-default" onclick="site.deleteChecked('\{{type.string}}')"><span class="glyphicon glyphicon-trash"></span></button>
                            <button class="btn btn-md btn-default" onclick="site.usrChecked('\{{type.string}}')"><span class="glyphicon glyphicon-tasks"></span></button>
                            </div></div>
                        </th>
                        <th>Owner</th>
                        <th>Title</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Created</th>
                    </thead>

                    <tbody id="result_tbody">

                            \{{#each items}}
                            <tr id="result_row_\{{id}}">
                                <td><input type="checkbox" id='selectCheckbox' value="\{{id}}"></td>
                                <td><a href="/user/\{{owner.id}}">\{{owner.displayName}}</a></td>
                                <td onclick="window.location.assign('/dataset/\{{id}}');">\{{title}} \{{type}}</td>
                                <td>\{{toDateString startTime}} \{{toTimeString startTime}}</td>
                                <td>\{{toDurationString startTime endTime}}</td>
                                <td>\{{toDateString createTime}} \{{toTimeString createTime}}</td>
                            </tr>
                            \{{/each}}
                    </tbody>
                </table>
            </div>
            \{{/if}}

            \{{#if type.event }}
            <div class="table-responsive">
                <table class="table table-hover table-condensed">
                    <thead>
                        <th><button class="btn btn-md btn-default" onclick="site.deleteChecked('\{{type.string}}')"><span class="glyphicon glyphicon-trash"></span></button></th>
                        <th>Type</th>
                        <th>Started</th>
                        <th>Duration</th>
                    </thead>
                    <tbody id="result_tbody">
                            \{{#each items}}
                            <tr id="result_row_\{{id}}">
                                <td><input type="checkbox" id='selectCheckbox' value="\{{id}}"></td>
                                <td onclick="window.location.assign('/dataset/\{{datasetId}}?startTime=\{{startTime}}&endTime=\{{endTime}}');">\{{type}}</td>
                                <td>\{{toDateString startTime}} \{{toTimeString startTime}}</td>
                                <td>\{{toDurationString startTime endTime}}</td>
                            </tr>
                            \{{/each}}
                    </tbody>
                </table>
            </div>
            \{{/if}}
        </div>

        <div>
            \{{#pager paging onclick="site.showResults(:0:)"}}\{{/pager}}
        </div>
    \{{else}}
        <div class="alert">No results found.</div>
    \{{/if}}
</script>

<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
<h2>Tools</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Administrator tools</strong></div>
    <ul class="list-group">
        <li class="list-group-item"><a href="/monitor">Monitoring</a></li>
    </ul>
</div>
