<script src="/js/async.js"></script>
<script src="/js/panelrequestqueue.js"></script>
<script src="/js/siteSpinLoader.js"></script>

<script src="/js/dygraph-custom.js"></script>

<script src="/js/lenses/eventlist.js"></script>
<script src="/js/lenses/googlemap.js"></script>
<script src="/js/lenses/graph.js"></script>
<script src="/js/lenses/summarystatistics.js"></script>



<!-- The Google Maps script tag should really be with the googlemaps.html
lens, but it turns out that it's subject to same origin policy. So, it's
here. 

Update: or something. I left this script in the googlemap.html file, thinking
it wouldn't do anything. Turns out, it does. It won't work with just the
script tag in googlemaps.html ("ReferenceError: google is not defined"), but
when I have both it and the script tag below I get inconsistent map loads.
Sometimes it loads, sometimes it loads a blank space. Grrr... -->
<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzYsEDTVazN_ic9SsHVvhcSCLwlLEHd7Q&amp;sensor=true&amp;libraries=geometry">
</script>

<script>

    /**
     * Generates a GUID string, according to RFC4122 standards.
     * @returns {String} The generated GUID.
     * @example af8a8416-6e18-a307-bd9c-f2c947bbb3aa
     * @author Slavik Meltser (slavik@meltser.info).
     * @link http://slavik.meltser.info/?p=142
     */
    function generateUUID() {
        function _p8(s) {
            var p = (Math.random().toString(16) + "000000000").substr(2, 8);
            return s ? "-" + p.substr(0, 4) + "-" + p.substr(4, 4) : p;
        }
        return (_p8() + _p8(true) + _p8(true) + _p8());
    }

    var apiUrl = '{{apiUrl}}';
    var datasetId = '{{dataset.id}}';
    var pageDataset;

    var lensesList = {};
    function updateRange(callerId, startTime, endTime, reference) {
        console.log('Reference: ' + JSON.stringify(reference));
        if ($('#sync_lenses_button').hasClass('active')) {
            _.each(lensesList, function(lens, id) {
                if (callerId !== id) {
                    lens.setRange(startTime, endTime, reference);
                }
            });
        }
    }

    function updateHover(id, time) {

    }

    function updateMarkers(id, markerATime, markerBTime) {

    }

    function updatePlaytime(id, time) {

    }

    function CreateLens(requestqueue, dataset, type, configuration) {
        var id = generateUUID();
        $('#lenses_div').append('<div class="row" id="' + id + '_container"></div>');
        var lens_parameters = {
            id: id,
            apiDomain: apiUrl,
            requestPanelFunction: $.proxy(requestqueue.requestPanel, requestqueue),
            updateRangeFunction: updateRange,
            updateHoverFunction: updateHover,
            updateMarkersFunction: updateMarkers,
            updatePlaytimeFunction: updatePlaytime
        };
        var lens;
        if (type === 'EventList') {
            lens = new EventList(lens_parameters, dataset, configuration);
        } else if (type === 'Graph') {
            lens = new Graph(lens_parameters, dataset, configuration);
        } else if (type === 'GoogleMap') {
            lens = new GoogleMap(lens_parameters, dataset, configuration);
        } else if (type === 'SummaryStatistics') {
            lens = new SummaryStatistics(lens_parameters, dataset, configuration);
        } else { // Not found...
            return;
        }

        lensesList[id] = lens;
    }


    function ConstructPage(datasetList) {
        var dataset = datasetList[0];
        pageDataset = dataset;

        var requestqueue = new RequestQueue({
            apiUrl: apiUrl
        }, dataset);


        CreateLens(requestqueue, dataset, 'EventList', {});

        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'gps:speed'
            ]
        });

        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'acceleration:x',
                'acceleration:y',
                'acceleration:z'
            ]
        });
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'rotationrate:x',
                'rotationrate:y',
                'rotationrate:z'
            ]
        });
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'magneticfield:x',
                'magneticfield:y',
                'magneticfield:z'
            ]
        });
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'pressure:pressure'
            ]
        });
        
        CreateLens(requestqueue, dataset, 'GoogleMap', {});

        CreateLens(requestqueue, dataset, 'SummaryStatistics', {});
        
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'gps:altitude'
            ]
        });
        
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'gps:hdop'
            ]
        });
        
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'gps:satellite'
            ]
        });
        
        







    }

    $(document).ready(function() {
        $.ajax({
            type: 'GET',
            url: apiUrl + '/dataset/' + datasetId + '?expand=owner,headPanel',
            dataType: 'json',
            success: ConstructPage
        });

        $('#reset_range_button').click(function() {
            updateRange(null, pageDataset.headPanel.startTime, pageDataset.headPanel.endTime, {type:'dataset', id:pageDataset.id});
        });




    });
    
    var usrModalInstance;
    function displayUsrModal() {
        
        if (typeof usrModalInstance === 'undefined') {
            console.log('First time load...');
            // First time, load modal
            $('#usr_modal_div').load('/snippet/usrmodal', function() {
                usrModalInstance = new usrModal();
                usrModalInstance.show();
            });
        } else {
            usrModalInstance.show();
        }
        
    }

    var GetUSROperands = function() {
        var result = {
            datasets: [
                datasetId
            ]
        };
        return result;
    };


</script>

<div id="usr_modal_div"></div>




<div id="create_event_modal"> <!--Loaded by jQuery--> </div>

<button id="reset_range_button" class="btn btn-default">Global Zoom Out</button>
<button id="sync_lenses_button" class="btn btn-default active" data-toggle="button">Sync Lenses</button>

<button onclick="displayUsrModal()" class="btn btn-default pull-right">Run USR</button>

<br /><br /><br />

<div id='lenses_div'>

</div>






<br /><br /><hr /><br /><br />





<h2>Summary</h2>


<div class="panel panel-default">
    <div class="panel-heading"><strong>&nbsp;</strong></div>

    <table cellpadding="3" cellspacing="3" class="table table-striped">
        <tr>
            <td><b>Dataset Title</b>
            </td>
            <td>{{{dataset.title}}}</td>
        </tr>
        <tr>
            <td><b>Owner</b>
            </td>
            <td><a href="/user/{{dataset.owner.id}}">{{{dataset.owner.displayName}}}</a>
            </td>
        </tr>
        <tr>
            <td><b>Start Time</b>
            </td>
            <td>{{{epochdate dataset.headPanel.startTime}}}&nbsp;&nbsp;&nbsp;{{{epochtime dataset.headPanel.startTime}}}</td>
        </tr>
        <tr>
            <td><b>End Time</b>
            </td>
            <td>{{{epochdate dataset.headPanel.endTime}}}&nbsp;&nbsp;&nbsp;{{{epochtime dataset.headPanel.endTime}}}</td>
        </tr>
        <tr>
            <td><b>Duration</b>
            </td>
            <td>{{{duration dataset.headPanel.startTime dataset.headPanel.endTime}}}</td>
        </tr>
        <tr>
            <td><b>Number of Rows</b>
            </td>
            <td>{{{dataset.rowCount}}}</td>
        </tr>
    </table>
</div>

<br />

<h2> Download</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Options</strong></div>
    <div class="panel-body">
        <h3>
            <a download="{{dataset.id}}-panel.csv" href="{{apiUrl}}/panel/{{dataset.headPanelId}}/body?minmax=false">Complete Panel</a>
            ~ <a href="/panel/{{dataset.id}}/download">Custom Panel</a>
        </h3>
    </div>
</div>
<br/>



<h2>Recording Source</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Information about the recorder that generated this dataset</strong></div>
    <div class="panel-body">
        <h3>Parsed Properties</h3>
        <div class="row">
            <div class="col-md-12"><strong>Filename</strong>: {{dataset.source.filename}}</div>
        </div>
        {{#if dataset.source.scad}}{{#with dataset.source.scad}}

        <div class="row">
            <div class="col-md-3">
                <div class="row"><div class="col-md-3"><strong>Unit</strong>: {{unit}}</div></div>
                <div class="row"><div class="col-md-3"><strong>Rows</strong>: {{rows}}</div></div>
            </div>
            <div class="col-md-4">
                <div class="row"><strong>Recorder Start Time</strong>:</div>
                <div class="row">{{epochdate datasetStartTime}} {{epochtime datasetStartTime}}<br/>({{datasetStartTime}})</div>
            </div>
            <div class="col-md-5">
                <div class="row"><strong>Recorder End Time</strong>:</div>
                <div class="row">{{epochdate datasetEndTime}} {{epochtime datasetEndTime}}<br/>({{datasetEndTime}})</div>
            </div>
        </div>


        <h3>RNC Properties</h3>
        {{#with rncParameters}}
        <div class="row">
            <div class="col-md-3"><strong>Sensors</strong><br/>
                <table class="table table-condensed">
                    <thead>
                    <th>Class</th><th>id</th><th>Name</th>
                    </thead>
                    <tbody>
                        {{#each sensors}}
                        <tr><td>{{@key}}</td><td>{{id}}</td><td>{{name}}</td></tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-4"><strong>Create CNT</strong>: {{createTime.timestamp}}</div>
                    <div class="col-md-5"><strong>Broken Time</strong>: {{createTime.brokenTime}}</div>
                </div>
                <div class="row">
                    <div class="col-md-4"><strong>Bits/Timestamp</strong>: {{timestampFormat.bitsPerTimestamp}}</div>
                    <div class="col-md-5"><strong>Frequency</strong>: {{timestampFormat.frequency}}</div>
                </div>
                <div class="row">
                    <div class="col-md-4"><strong>SW Version</strong>: {{softwareVersion}}</div>
                    <div class="col-md-5"><strong>Create Filename</strong>: {{createName}}</div>
                </div>

            </div>
        </div>
        {{/with}}

        {{/with}}{{else}}
        Unknown source (not SCAD).
        {{/if}}


    </div>
</div>

<br />


<br /> <b>Dataset UUID: </b> {{dataset.id}}
<br /> <b>Raw Data UUID: </b> {{dataset.headPanelId}}
<br />






