<script src="/js/moment.js"></script>

<script src="/js/lenses/eventlist.js"></script>
<script src="/js/lenses/googlemap.js"></script>
<script src="/js/lenses/graph.js"></script>
<script src="/js/async.js"></script>
<script src="/js/panelrequestqueue.js"></script>

<script src="/js/dygraph-custom.js"></script>

<!-- The Google Maps script tag should really be with the googlemaps.html
lens, but it turns out that it's subject to same origin policy. So, it's
here. 

Update: or something. I left this script in the googlemap.html file, thinking
it wouldn't do anything. Turns out, it does. It won't work with just the
script tag in googlemaps.html ("ReferenceError: google is not defined"), but
when I have both it and the script tag below I get inconsistent map loads.
Sometimes it loads, sometimes it loads a blank space. Grrr... -->
<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzYsEDTVazN_ic9SsHVvhcSCLwlLEHd7Q&amp;sensor=true&amp;libraries=geometry">
</script>

<script>

    /**
     * Generates a GUID string, according to RFC4122 standards.
     * @returns {String} The generated GUID.
     * @example af8a8416-6e18-a307-bd9c-f2c947bbb3aa
     * @author Slavik Meltser (slavik@meltser.info).
     * @link http://slavik.meltser.info/?p=142
     */
    function generateUUID() {
        function _p8(s) {
            var p = (Math.random().toString(16) + "000000000").substr(2, 8);
            return s ? "-" + p.substr(0, 4) + "-" + p.substr(4, 4) : p;
        }
        return (_p8() + _p8(true) + _p8(true) + _p8());
    }

    var apiUrl = '{{apiUrl}}';
    var datasetId = '{{dataset.id}}';
    var pageDataset;

    var lensesList = {};
    function updateRange(callerId, startTime, endTime) {
        console.log("You've updated the time: " + startTime + " - " + endTime);
        if ($('#sync_lenses_button').hasClass('active')) {
            _.each(lensesList, function(lens, id) {
                if (callerId !== id) {
                    lens.setRange(startTime, endTime);
                }
            });
        }
    }

    function updateHover(id, time) {

    }

    function updateMarkers(id, markerATime, markerBTime) {

    }

    function updatePlaytime(id, time) {

    }

    function CreateLens(requestqueue, dataset, type, configuration) {
        var id = generateUUID();
        $('#lenses_div').append('<div class="row" id="' + id + '_container"></div>');
        var lens_parameters = {
            id: id,
            apiDomain: apiUrl,
            requestPanelFunction: $.proxy(requestqueue.requestPanel, requestqueue),
            updateRangeFunction: updateRange,
            updateHoverFunction: updateHover,
            updateMarkersFunction: updateMarkers,
            updatePlaytimeFunction: updatePlaytime
        };
        var lens;
        if (type === 'EventList') {
            lens = new EventList(lens_parameters, dataset, configuration);
        } else if (type === 'Graph') {
            lens = new Graph(lens_parameters, dataset, configuration);
        } else if (type === 'GoogleMap') {
            lens = new GoogleMap(lens_parameters, dataset, configuration);
        } else { // Not found...
            return;
        }

        lensesList[id] = lens;
    }


    function ConstructPage(datasetList) {
        var dataset = datasetList[0];
        pageDataset = dataset;

        var requestqueue = new RequestQueue({
            apiUrl: apiUrl
        }, dataset);


        CreateLens(requestqueue, dataset, 'EventList', {});

        CreateLens(requestqueue, dataset, 'GoogleMap', {});

        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'gps:speed'
            ]
        });

        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'acceleration:x',
                'acceleration:y',
                'acceleration:z'
            ]
        });
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'rotationrate:x',
                'rotationrate:y',
                'rotationrate:z'
            ]
        });
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'magneticfield:x',
                'magneticfield:y',
                'magneticfield:z'
            ]
        });
        CreateLens(requestqueue, dataset, 'Graph', {
            axes: [
                'pressure:pressure'
            ]
        });






    }

    $(document).ready(function() {
        $.ajax({
            type: 'GET',
            url: apiUrl + '/dataset/' + datasetId,
            dataType: 'json',
            success: ConstructPage
        });

        $('#reset_range_button').click(function() {
            updateRange(null, pageDataset.startTime, pageDataset.endTime);
        });
        
        $('#run_usr_on_dataset_button').click(function(){
            $('#usr_modal_div').load('/snippet/usrmodal', function(){
                $('#usr_modal').modal('show');
            });
        });


    });
    
    var GetUSROperands = function(){
        var result = {
            
          datasets:[
              datasetId
          ]  
        };
        return result;
    };


</script>






<div id="create_event_modal"> <!--Loaded by jQuery--> </div>

<button id="reset_range_button" class="btn btn-default">Global Zoom Out</button>
<button id="sync_lenses_button" class="btn btn-default active" data-toggle="button">Sync Lenses</button>

<button id="run_usr_on_dataset_button" class="btn btn-default pull-right">Run USR</button>

<br /><br /><br />

<div id='lenses_div'>

</div>






<br /><br /><hr /><br /><br />





<h2>Summary</h2>


<div class="panel panel-default">
    <div class="panel-heading"><strong>&nbsp;</strong></div>

    <table cellpadding="3" cellspacing="3" class="table table-striped">
        <tr>
            <td><b>Dataset Title</b>
            </td>
            <td>{{{dataset.title}}}</td>
        </tr>
        <tr>
            <td><b>Owner</b>
            </td>
            <td><a href="/user/{{dataset.owner.id}}">{{{dataset.owner.displayName}}}</a>
            </td>
        </tr>
        <tr>
            <td><b>Start Time</b>
            </td>
            <td>{{{epochdate dataset.startTime}}}&nbsp;&nbsp;&nbsp;{{{epochtime dataset.startTime}}}</td>
        </tr>
        <tr>
            <td><b>End Time</b>
            </td>
            <td>{{{epochdate dataset.endTime}}}&nbsp;&nbsp;&nbsp;{{{epochtime dataset.endTime}}}</td>
        </tr>
        <tr>
            <td><b>Duration</b>
            </td>
            <td>{{{duration dataset.startTime dataset.endTime}}}</td>
        </tr>
        <tr>
            <td><b>Number of Rows</b>
            </td>
            <td>{{{dataset.rowCount}}}</td>
        </tr>
    </table>
</div>

<br />

<h2> Download</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Options</strong></div>
    <div class="panel-body">
        <h3>
            <a download="{{dataset.id}}-panel.csv" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?minmax=false">Complete Panel</a>
            ~ <a href="/dataset/{{dataset.id}}/download">Custom Panel</a>
        </h3>


        <h5>Download Sensors: <a download="{{dataset.id}}-accl.csv" target="_blank" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?axes=acceleration:x,acceleration:y,acceleration:z&minmax=false">Accelerometer</a>
            ~ <a download="{{dataset.id}}-gyro.csv" target="_blank" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?axes=rotationrate:x,rotationrate:y,rotationrate:z&minmax=false">Gyroscope</a>
            ~ <a download="{{dataset.id}}-magn.csv" target="_blank" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?axes=magneticfield:x,magneticfield:y,magneticfield:z&minmax=false">Magnetometer</a>
            ~ <a download="{{dataset.id}}-baro.csv" target="_blank" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?axes=pressure:pressure&minmax=false">Barometer</a>
            ~ <a download="{{dataset.id}}-temp.csv" target="_blank" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?axes=pressure:temperature&minmax=false">Temperature</a>
            ~ <a download="{{dataset.id}}-gps.csv" target="_blank" href="{{apiUrl}}/dataset/{{dataset.id}}/panel?axes=gps:latitude,gps:longitude&minmax=false">GPS</a>

        </h5>
    </div>
</div>
<br/>



<h2>Processing Statistics</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Outputs from the conversion</strong></div>
    <div class="panel-body">
        <pre><code>
{{{dataset.processing_statistics}}}
</code></pre>
    </div>
</div>

<br />

<h2>Processing Configuration</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Parameters to the conversion</strong></div>
    <div class="panel-body">
        <pre><code>
{{{dataset.processing_config}}}
</code></pre>
    </div>
</div>


<br />


<h2>Processing Notes</h2>
<div class="panel panel-default">
    <div class="panel-heading"><strong>Comments from the conversion</strong></div>
    <div class="panel-body">
        <pre><code>
{{{dataset.processing_notes}}}
</code></pre>
    </div>
</div>

<br />


<br /> <b>Dataset UUID: </b> {{dataset.id}}
<br /> <b>Raw Data UUID: </b> {{dataset.headPanelId}}
<br />


<div id="usr_modal_div"></div>



